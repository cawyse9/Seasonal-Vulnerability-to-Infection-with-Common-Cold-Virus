library(mctest)
library(regclass)
library(psych)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library("jtools")
library("ggstance")
library("broom.mixed")
library(ggplot2)
library(viridis)
library("ggeffects")
library(ggpubr)
library(table1)
library(tableone)
library(finalfit)
library(dplyr)
library(knitr)
library(lme4)


#checking viruses infected
apply((AC[virus]), 2, table)

#these are the viruses in Pittsburgh
virus<-c('hanks', 'flu','rv39','rv23')

hanks<-AC[AC$hanks==1,]
flu<-AC[AC$flu==1,]
rv39<-AC[AC$rv39==1,]
rv23<-AC[AC$rv23==1,]

barplot(prop.table(table(hanks$post.objcold,hanks$month),2))
barplot(prop.table(table(flu$post.objcold,flu$month),2))
barplot(prop.table(table(rv39$post.objcold,rv39$month),2))
barplot(prop.table(table(rv23$post.objcold,rv23$month),2))
barplot(prop.table(table(AC$post.objcold,AC$month),2))

#remove all infection except rv39 as not challenged every month, flu is not a cold virus
AC_rv39<-AC[AC$rv39==1,]

table(AC_rv39$post.infected,AC_rv39$month)

#make new dataframe for diseased if infected, ie remove unsucessful infections
AC_rv39_infected <- AC_rv39 %>% filter (post.infected=="Yes")
round(prop.table(table(AC_rv39_infected$post.objcold,AC_rv39_infected$season),2),2)
barplot(prop.table(table(AC_rv39_infected$post.objcold,AC_rv39_infected$season),2))
barplot(prop.table(table(AC_rv39$post.infected,AC_rv39$month),2),main="infection")
barplot(prop.table(table(AC_rv39$post.objcold,AC_rv39$month),2),main="disease")
barplot(prop.table(table(AC_rv39$post.infected,AC_rv39$month),2))

#infected more likely in summer
barplot(prop.table(table(AC_rv39$post.infected,AC_rv39$month),2))
round(prop.table(table(AC_rv39$post.infected,AC_rv39$month),2),2)

#disease more likely in winter?
barplot(prop.table(table(AC_rv39$post.objcold,AC_rv39$month),2))
round(prop.table(table(AC_rv39$post.objcold,AC_rv39$month),2),2)

#shedding more likely in winter
barplot(prop.table(table(infected$post.shedany,infected$month),2))
round(prop.table(table(infected$post.shedany,infected$month),2),2)

#seroconversion no pattern
barplot(prop.table(table(infected$seroconv_c,infected$month),2))
round(prop.table(table(infected$seroconv_c,infected$month),2),2)

round(prop.table(table(AC_rv39$seroconv_c)),2)
round(prop.table(table(AC_rv39$post.infected)),2)
round(prop.table(table(AC_rv39$post.shedany)),2)

#by season - colds more likely in winter if infected
barplot(round(prop.table(table(AC_rv39_infected$post.objcold,AC_rv39_infected$season),2),2))
round(prop.table(table(AC_rv39_infected$post.objcold,AC_rv39_infected$season),2),2)
plot(AC_rv39$daylength,AC_rv39$TOBS)

barplot(round(prop.table(table(AC_rv39$post.objcold, AC_rv39$season),2),2),
        main="Probability of Resisting Disease by Season",
        xlab="Season",
        ylab="Probability",
        col=c("midnightblue","lightblue"),
        names.arg=c("Spring","Summer","Autumn", "Winter"))
barplot(round(prop.table(table(AC_rv39_infected$post.objcold, AC_rv39_infected$season),2),2),
        main="Probability of Resisting Disease if Infected",
        xlab="Season",
        ylab="Probability",
        col=c("midnightblue","lightblue"),
        names.arg=c("Spring","Summer","Autumn", "Winter"))

barplot(round(prop.table(table(AC_rv39$post.objcold, AC_rv39$season),2),2),
        main="Overall Probability of Resisting Disease",
        xlab="Season",
        ylab="Probability",
        col=c("midnightblue","lightblue"),
        names.arg=c("Spring","Summer","Autumn", "Winter"))

#by season, infection more likely in summer
barplot(round(prop.table(table(AC_rv39$post.infected, AC_rv39$season),2),2))
round(prop.table(table(AC_rv39$post.infected,AC_rv39$season),2),2)

barplot(round(prop.table(table(AC_rv39$post.infected, AC_rv39$season),2),2),
        main="Probability of Resisting Infection by Season",
        xlab="Season",
        ylab="Probability",
        col=c("midnightblue","lightblue"),
        names.arg=c("Spring","Summer","Autumn", "Winter"))

barplot(sesmeans, main = "Math by SES", xlab = "SES", ylab = "Mean Math Score", 
        ylim = c(0, 60), names.arg = c("Low", "Mid", "High"))

#logistic regression - is infection more likely in winter
x<-glm(post.infected~daylength + age + sex + TOBS,family="binomial", data=AC_rv39)
summary(x)
tab_model(x)

#########################################################
# final results
#########################################################

#logistic regression - is disease more likely in winter given infection status

#get social variable
AC_rv39a<-merge(AC_rv39,FIVE_STUDY_DATA[,c("subj_id", "sni.network")],by="subj_id")
AC_rv39_infected<-merge(AC_rv39_infected,FIVE_STUDY_DATA[,c("subj_id", "sni.network")],by="subj_id")

#get health variable - not enough samples n ~ 300
AC_rv39a<-merge(AC_rv39a,FIVE_STUDY_DATA[,c("subj_id", "srh.genhlth")],by="subj_id")
AC_rv39a$srh.genhlth.x<-factor(AC_rv39a$srh.genhlth.x)
table(AC_rv39a$srh.genhlth.x,AC_rv39a$study.id.x)

#########################################################
# Cleaning data for final models
#########################################################

#mixed model study id as random effect
m1<-glmer(post.infected~daylength + age + sni.network + sex + physactn + (1|subj_id),nAGQ = 0 ,family="binomial", data=AC_rv39a)
m2<-glmer(post.objcold~daylength + age + sni.network + sex + physactn + (1|subj_id),nAGQ = 0 ,family="binomial", data=AC_rv39_infected)

#mixed model with study id as random effect and virus as fixed effect, but removing  and flu
pitts_virus$virus<-as.factor(pitts_virus$virus)
x<-pitts_virus[pitts_virus$virus!="Flu",]
x<-merge(x,FIVE_STUDY_DATA[,c("subj_id", "sni.network")],by="subj_id")
x<-merge(x,FIVE_STUDY_DATA[,c("subj_id", "educ.4cat")],by="subj_id")
x<-merge(x,FIVE_STUDY_DATA[,c("subj_id", "hsetot")],by="subj_id")
x$hsetot<-as.numeric(x$hsetot)

x$educ.4cat<-factor(x$educ.4cat)
x<-merge(x,FIVE_STUDY_DATA[,c("subj_id", "pre_ab")],by="subj_id")
x$educ.4cat<-factor(x$educ.4cat)

#>1 is threshold for immunity 408/978 had titre of 1, set to factor 0
x$pre_igg<-ifelse(as.numeric(x$pre_ab) >1, "1", "0")
table(as.numeric(x$pre_igg))
x$pre_ab<-as.numeric(x$pre_ab)

x$pre_igg_16<-ifelse(as.numeric(x$pre_ab)<, "1", "0")
table(as.numeric(x$pre_igg_16))
x$pre_igg_16<-factor(as.numeric(x$pre_igg_16))
str(x$pre_igg_16)

#Serologic status was defined as positive when a subject had a base-line neutralizing antibody titer above 2 for rhinoviruses and a base-line antibody level greater than the sample median for coronavirus or respiratory syncytial virus
#summary(glmer(post.infected ~ daylength + pre_igg_16 + drinks +  (1|study.id.x) ,nAGQ = 0 ,family="binomial", data=x))

#1=<1:2
#2=1:2 or <1:4
#4=1:4 or <1:8
#8=1:8 or <1:16
#16=1:16 or >1:16

table(x$pre_ab)
hist((x$pre_ab))

table(x$pre_igg)
x$pre_ab_F<-factor(x$pre_ab)

all_data$alco

x$pre_igg<-as.numeric(x$pre_igg)

#make alcohol binary as more than half didn't drink
hist(x$alc.totdrnks)
x$drinks<-ifelse(as.numeric(x$alc.totdrnks) > 1, "1", "0")
table(as.numeric(x$drinks))
x$drinks<-factor(x$drinks)

#============================================================================================================================log(alc.totdrnks+1)log(alc.totdrnks+1)
#     #final models             #mixed model with study id and subject as random effect removing flu                        =
#============================================================================================================================


notflu_infect<-glmer(post.infected ~ daylength + age + sex + bodymass + pre_igg + educ.4cat + sni.network + slpduration + physact +smk.now + drinks + (1|subj_id) + (1|study.id.x) ,nAGQ = 0 ,family="binomial", data=x)
notflu_disease<-glmer(post.objcold ~ daylength + age + sex + bodymass + pre_igg + educ.4cat + sni.network + slpduration + physact +smk.now + drinks + (1|subj_id) + (1|study.id.x),nAGQ = 0 ,family="binomial", data=x[x$post.infected=="Yes",])
plot(PCS_infect)
tab_model(notflu_disease)
tab_model(notflu_infect)
plot(x$daylength)

summary(glmer(post.infected ~ daylength + pre_igg_16 + drinks +  (1|study.id.x) ,nAGQ = 0 ,family="binomial", data=x))
summary(glmer(post.objcold ~ daylength + age + pre_igg_16 + smk.now+ (1|study.id.x),nAGQ = 0 ,family="binomial", data=x[x$post.infected=="Yes",]))
summary(glmer(post.infected ~ daylength + log(pre_igg_16) +  drinks +  (1|study.id.x),nAGQ = 0 ,family="binomial",data=x))

#final models for inclusion - predictors chosen from univariate analysis
PCS_infect<-glmer(post.infected ~ daylength + pre_igg + drinks + (1|study.id.x),nAGQ = 0 ,family="binomial", data=x)
PCS_disease<-glmer(post.objcold ~ daylength + age + pre_igg + sni.network + educ.4cat + slpduration +smk.now+ (1|study.id.x),nAGQ = 0 ,family="binomial", data=x[x$post.infected=="Yes",])
tab_model(PCS_infect)
#get confidence intervals and pvalues
library(broom.mixed)
tidy(PCS_infect,conf.int=TRUE,exponentiate=TRUE,effects="fixed")
tidy(PCS_disease,conf.int=TRUE,exponentiate=TRUE,effects="fixed")

########################################################


#ordinary glm, no random effects, only rv39
getinfected<-glm(post.infected~daylength + study.id.x  + sni.network+age  + sex + ,family="binomial", data=AC)
summary(getinfected)
getinfect_table<-tab_model(getinfected)
prop.table(table(x$pre_ab,x$post.infected),margin=1)
getdisease<-glm(post.objcold~daylength + study.id.x + age + sni.network + sex + physactn,family="binomial", data=AC_rv39_infected)
getdisease_table<-tab_model(getdisease)


#####################################################################################
# figure 1
#####################################################################################

#change m1 and m2 to all except flu
m1<- notflu_infect
m2<- notflu_disease

forest1<-plot_summs(m1,m2, exp=TRUE,
                model.names=c("Post-Challenge Infection","Post-Infection Clinical Disease"),
                legend.title="Model Outcome",
                colors=c("#EFC00099", "#0073C299"),
                
                inner_ci_level = .95,
                coefs = c("Daylength" = "daylength",
                     "Age" = "age",
                     "Sex" = "sex",
                     "BMI" = "bodymass",
                     "Baseline Immunity" = "pre_igg",
                     "Social Networks" = "sni.network",
                     "Sleep" = "slpduration",
                     #"Physical Activity"="physact",
                     #"Smoking" = "smk.now",
                     "Alcohol" = "drinks"),
                      scale = TRUE
                      )
forest1 <- forest1 +
        xlab("Odds Ratio and 95% CI")+
        ylab("" )+
        theme_minimal()+
        ggtitle("Pittsburgh Cold Studies") 

#using ggsave
ggsave("Fig1a.png", units="in", width=6, height=5, dpi=300)

figure1 <- ggarrange(forest1,forest2,
                     #labels = c("A","B"),
                     ncol = 2, nrow = 1,
                     common.legend=TRUE,
                     legend = "bottom")
figure1

#####################################################################################
# figure 2
#####################################################################################
install.packages("lmer4")

#get predicted marginal probabilities
data1<-ggpredict(m1,"daylength [all]")#infect
data2<-ggpredict(m2,"daylength [all]")
data3<-ggpredict(m3,"daylength [all]")

plot(predict(m1,type="response"))

ggplot(data3, aes(x = x, y = predicted)) +
        geom_line() +
        geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .15) +
        theme_bw()
#c("#EFC00099", "#0073C299"),
 
prob_infect<-ggplot(data1, aes(x = x, y = predicted, colour = group)) +
                 geom_line() +
                 geom_ribbon( aes(ymin = conf.low, ymax = conf.high, fill = group, color = NULL), alpha = .15) +
                 theme_bw() +
                 xlab("Daylength (hours)") + ylab("Predicted Probability of Infection")+
                 scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
                 
        scale_color_manual(values=c("#0073C299"))+
        scale_fill_manual(values=c("#0073C299"))+
                 theme( axis.title=element_text(size=8),axis.text.y = element_text(size = 8),axis.text.x = element_text(size = 8),legend.position = "none",panel.background = element_blank(),panel.grid.major=element_blank(), panel.grid.minor=element_blank(),panel.border=element_blank(), axis.line=element_line())

prob_cold<-ggplot(data2, aes(x = x, y = predicted, colour = group)) +
                 geom_line() +
                 geom_ribbon( aes(ymin = conf.low, ymax = conf.high, fill = group, color = NULL), alpha = .15) +
                 #ylim(30,90)+
                 xlab("Daylength (hours)") + 
                 ylab("Predicted Probability of Clinical Disease")+
                 scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(.2,.6))+
                 scale_color_manual(values=c("#EFC00099"))+
                 scale_fill_manual(values=c("#EFC00099"))+
                 theme( axis.title=element_text(size=8),axis.text.y = element_text(size = 6),axis.text.x = element_text(size = 6),legend.position = "none",panel.background = element_blank(),panel.grid.major=element_blank(), panel.grid.minor=element_blank(),panel.border=element_blank(), axis.line=element_line())


###############################################################################
#  bargraphs of season for all but flu including BCS  
###############################################################################

infected_bc<-prop.table(table(BCS$season,BCS$post.infected),1)
diseased_bc<-prop.table(table(BCS[BCS$post.infected==1,]$season,BCS[BCS$post.infected==1,]$post.clincold),1)

infected_pc<-prop.table(table(x$season,x$post.infected),1)
diseased_pc<-prop.table(table(x[x$post.infected=="Yes",]$season,x[x$post.infected=="Yes",]$post.objcold),1)

dat <- data.frame(season = c("Winter", "Spring", "Summer","Fall"), 
                  Infected=infected_pc[1:4,2], Diseased=diseased_pc[1:4,2], Infected_BC = infected_bc[1:4,2], Diseased_BC = diseased_bc[1:4,2])

dat$season<-factor(dat$season, levels = c("Spring","Summer","Fall","Winter"))

table(dat$Diseased,dat$season)

pitts_disease<-ggbarplot(dat, x="season", y="Diseased",
                xlab="",
                ylab="Participants with Disease",
                main="",
                alpha=1,
                ylim=c(0.3,.5),
                color="#21918c",
                fill="#21918c"
                )+
scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
        theme(axis.text.y = element_text(size=8))

pitts_infect<-ggbarplot(dat, x="season", y="Infected",
               xlab="",
               ylab="Participants Infected",
               main="Pittsburgh Cold Studies",
               alpha=1,
               ylim=c(0.6,.9),
               color="#440154",
               fill="#440154"
                )+
scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
        theme(axis.text.y = element_text(size=8))

bcs_disease<-ggbarplot(dat, x="season", y="Diseased_BC",
                         xlab="",
                         ylab="Particiants with Disease",
                         main="",
                         #alpha=.7,
                         ylim=c(0.3,.6),
                         color="#21918c",
                       fill="#21918c"
)+
        scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
theme(axis.text.y = element_text(size=8))
bcs_infect<-ggbarplot(dat, x="season", y="Infected_BC",
                        xlab="",
                        ylab="Participants Infected",
                        main="British Cold Study",
                        #alpha=0.7,
                        ylim=c(0.75,.9),
                        color="#440154",
                        fill="#440154"
)+
        scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
        theme(axis.text.y = element_text(size=8))

figure2 <- ggarrange(pitts_infect,pitts_disease,bcs_infect,bcs_disease,
                    labels = c("A", "", "B","" ),
                    ncol = 2, nrow = 2)
figure2
ggsave("Fig2.png", units="in", width=8, height=8, dpi=300)



ggbarplot(dat, x = "season", y = "Infected",
          #add = "mean_se", 
          xlab="",
          ylab="Participants Infected Post-Challenge",
          #error.plot = "upper_errorbar",
          alpha=0.4,
          ylim=c(0.7,.9),
          color= "#0073C299",
          fill="#0073C299"  ) 

ggbarplot(dat, x = "season", y = "Diseased",
          #add = "mean_se", 
          xlab="",
          ylab="Participants with Clinical Disease Post-Infection",
          #error.plot = "upper_errorbar",
          alpha=0.4,
          ylim=c(0.3,.6),
          color= "#EFC00099",
          fill="#EFC00099" )+
        theme(axis.title=element_text(size=8),axis.text.x = element_text(size = 8),axis.text.y = element_text(size = 6),panel.grid.major=element_blank(), panel.grid.minor=element_blank(),panel.border=element_blank(), axis.line=element_line())+
        scale_y_continuous(labels = scales::percent)


###########################################
#  TABLE 1
#############################################

#variables for table 1
#age+sex+race+sescom+physactn+bodymass+post.infected+post.objcold

#make table 1
my.render.cont <- function(x) {with(stats.apply.rounding(stats.default(x), digits=4), c("","Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))}
my.render.cat <- function(x) {c("", sapply(stats.default(x), function(y) with(y, sprintf("%d (%0.0f %%)", FREQ, PCT))))}
my.render.NP_cont <- function(x) {with(stats.apply.rounding(stats.default(x), digits=0), c("","Median (IQR)"=sprintf("%s (&plusmn; %s)", MEDIAN, IQR)))}

table1 <- table1(~ age + sex + bodymass + pre_igg + educ.4cat + sni.network + slpduration + physact +smk.now + drinks +post.infected+post.objcold,  data=x, overall=TRUE, render.continuous=my.render.cont, render.categorical=my.render.cat)
tables_bydisease <- table1(~ daylength +age + sex + bodymass + pre_igg + educ.4cat + sni.network + slpduration + physact +smk.now + drinks|post.objcold,  data=x[x$post.infected=="Yes",], overall=TRUE, render.continuous=my.render.cont, render.categorical=my.render.cat)
table_byintfected <- table1(~ daylength +age + sex + bodymass + pre_igg + educ.4cat + sni.network + slpduration + physact +smk.now + drinks|post.infected,  data=x, overall=TRUE, render.continuous=my.render.cont, render.categorical=my.render.cat)


varsP<-c('daylength', 'age' , 'sex', 'bodymass' , 'pre_igg' , 'physact' , 'educ.4cat' , 'sni.network' , 'smk.now' , 'drinks' , 'slpduration')

tableOne_PCS_infect <- CreateTableOne(vars = varsP, strata = c("post.infected"), data = x)
tableOne_PCS_disease <- CreateTableOne(vars = varsP, strata = c("post.objcold"), data=x[x$post.infected=="Yes",])

 
#################################################################################################
# S3 virus tables
#################################################################################################
#make new variable for virus

virus<-c('hanks', 'flu','rv39','rv23')
pitts_virus<-AC %>% mutate(
        virus = case_when(
                hanks == 1 ~ 'Hanks',
                flu == 1   ~ 'Flu',
                rv39 == 1  ~ 'rv39',
                rv23 == 1  ~ 'rv32',
                
                TRUE          ~ "NA"       
        )
)
table(pitts_virus$season,pitts_virus$virus)
tab_xtab (pitts_virus$month, pitts_virus$virus)
tab_xtab (pitts_virus$season, pitts_virus$virus)
