library(mctest)
library(regclass)
library(psych)
library(dplyr)

BCS<-BCS_DATA_082015

#checking viruses infected
table(Ava_BCS["rv2"])
table(Ava_BCS["rv9"])
table(Ava_BCS["rv14"])
table(Ava_BCS["rv23"])
table(Ava_BCS["rv39"])
table(Ava_BCS["cov229e"])
table(Ava_BCS["rsv" ])
table(Ava_BCS["hanks" ])
table(Ava_BCS["flu" ])

#merge BCS to get daylength
BCS<-merge(x=BCS,y=all_data[,c("daylength","subj_id")], by="subj_id")
BCS$daylength<-BCS$daylength.x


rv2<-Ava_BCS[Ava_BCS$rv2==1,]
rv9<-Ava_BCS[Ava_BCS$rv9==1,]
rv14<-Ava_BCS[Ava_BCS$rv14==1,]
cov229e<-Ava_BCS[Ava_BCS$cov229e==1,]
rsv<-Ava_BCS[Ava_BCS$rsv==1,]

table(Ava_BCS$pre_ab,Ava_BCS$virus)


#these are the viruses in BCS
virus_BCS<-c("rv2","rv9","rv14","cov229e","rsv")

#make new variable for virus
BCS<-BCS %>% mutate(
  virus = case_when(
    rv2 == 1      ~ 'rv2',
    rv9 == 1      ~ 'rv9',
    rv14 == 1     ~ 'rv14',
    cov229e == 1  ~ 'cov229e',
    rsv == 1      ~ 'rsv',
    TRUE          ~ "NA"       
  )
)

rv2<-BCS[BCS$rv2==1,]
rv9<-BCS[BCS$rv9==1,]
rv14<-BCS[BCS$rv14==1,]
cov229e<-BCS[BCS$cov229e==1,]
rsv<-BCS[BCS$rsv==1,]


Ava_BCS$virus

#check if they were challenged every month
barplot(prop.table(table(Ava_BCS$rv14,Ava_BCS$month),2))
barplot(prop.table(table(Ava_BCS$rv2,Ava_BCS$month),2))
barplot(prop.table(table(Ava_BCS$rv9,Ava_BCS$month),2))
barplot(prop.table(table(Ava_BCS$cov229e,Ava_BCS$month),2))

barplot(prop.table(table(Ava_BCS$rv14,Ava_BCS$month),2))
barplot(prop.table(table(Ava_BCS$rv2,Ava_BCS$month),2))
barplot(prop.table(table(Ava_BCS$rv9,Ava_BCS$month),2))
barplot(prop.table(table(Ava_BCS$cov229e,Ava_BCS$month),2))

table(Ava_BCS$rv2,Ava_BCS$month)
table(Ava_BCS$rv9,Ava_BCS$month)
table(Ava_BCS$rv14,Ava_BCS$month)
table(Ava_BCS$cov229e,Ava_BCS$month)
table(Ava_BCS$rsv,Ava_BCS$month)

#check seasonality of each virus
barplot(prop.table(table(rv2$post.clincold,rv2$month),2))
barplot(prop.table(table(rv9$post.clincold,rv9$month),2))
barplot(prop.table(table(rv14$post.clincold,rv14$month),2))
barplot(prop.table(table(cov229e$post.clincold,cov229e$month),2))
barplot(prop.table(table(rsv$post.clincold,rsv$month),2))
barplot(prop.table(table(BCS$post.clincold,BCS$month),2))

barplot(prop.table(table(rv2$post.infected,rv2$month),2))
barplot(prop.table(table(rv9$post.infected,rv9$month),2))
barplot(prop.table(table(rv14$post.infected,rv14$month),2))
barplot(prop.table(table(cov229e$post.infected,cov229e$month),2))
barplot(prop.table(table(rsv$post.infected,rsv$month),2))

barplot(prop.table(table(x$post.infected,x$month),2))



barplot(table(rv2$post.infected,rv2$month),2)
barplot(table(rv9$post.infected,rv9$month),2)
barplot(table(rv14$post.infected,rv14$month),2)
barplot(table(cov229e$post.infected,cov229e$month),2)
barplot(table(rsv$post.infected,rsv$month),2)
barplot(table(Ava_BCS$post.infected,Ava_BCS$month),2)

barplot(prop.table(table(rv2$post.clincold,rv2$season),2))
barplot(prop.table(table(rv9$post.clincold,rv9$season),2))
barplot(prop.table(table(rv14$post.clincold,rv14$season),2))
barplot(prop.table(table(cov229e$post.clincold,cov229e$season),2))
barplot(prop.table(table(rsv$post.clincold,rsv$season),2))
barplot(prop.table(table(factor(Ava_BCS_infected$post.clincold),Ava_BCS_infected$season),2))
barplot(prop.table(table(factor(Ava_BCS_rv9_14_infect$post.clincold),Ava_BCS_rv9_14_infect$season),2))


barplot(prop.table(table(rv2$post.infected,rv2$season),2))
barplot(prop.table(table(rv9$post.infected,rv9$season),2))
barplot(prop.table(table(rv14$post.infected,rv14$season),2))
barplot(prop.table(table(cov229e$post.infected,cov229e$season),2))
barplot(prop.table(table(rsv$post.infected,rsv$season),2))
barplot(prop.table(table(factor(Ava_BCS$post.infected),Ava_BCS$season),2))

barplot(prop.table(table(factor(Ava_BCS_rv9_14_infect$post.clincold),Ava_BCS_rv9_14_infect$season),2))
barplot(prop.table(table(factor(Ava_BCS_rv9_14$post.infected),Ava_BCS_rv9_14$season),2))



barplot(table(rv2$post.infected,rv2$season),2)
barplot(table(rv9$post.infected,rv9$season),2)
barplot(table(rv14$post.infected,rv14$season),2)
barplot(table(cov229e$post.infected,cov229e$month),2)
barplot(table(rsv$post.infected,rsv$season),2)
barplot(table(Ava_BCS$post.infected,Ava_BCS$season),2)


#coronavirus - not enough summer data and allows only rv to be in both datasets
#rsv, not enough infections at different times of the year
#make new dataset without coronavirus and rsv
Ava_BCS_virus<-Ava_BCS[Ava_BCS$rsv==0,]
Ava_BCS_virus<-Ava_BCS_virus[Ava_BCS_virus$cov229e==0,]


Ava_BCS_rv9_14<-Ava_BCS[(Ava_BCS$rv14==1|Ava_BCS$rv9==1),]
Ava_BCS_rv9_14_infect<- Ava_BCS_rv9_14 %>% filter (post.infected=="Yes")


#make new dataframe for diseased if infected, ie remove unsucessful infections
Ava_BCS_infected <- Ava_BCS %>% filter (post.infected=="Yes")
round(prop.table(table(Ava_BCS_infected$post.clincold,Ava_BCS_infected$season),2),2)

#check likelihood of cold if infected - more likely to get a cold if infected in winter
barplot(prop.table(table(Ava_BCS_infected$post.clincold,Ava_BCS_infected$month),2))
round(prop.table(table(Ava_BCS_infected$post.clincold,Ava_BCS_infected$month),2),2)

#infected more likely in summer
barplot(prop.table(table(Ava_BCS_virus$post.infected,Ava_BCS_virus$month),2))
round(prop.table(table(Ava_BCS_virus$post.infected,Ava_BCS_virus$month),2),2)

#shedding ?
barplot(prop.table(table(Ava_BCS_infected$post.shedany,Ava_BCS_infected$month),2))
round(prop.table(table(infected$post.shedany,infected$month),2),2)

#seroconversion ?
barplot(prop.table(table(Ava_BCS_virus$seroconv_c,Ava_BCS_virus$month),2))
round(prop.table(table(infected$seroconv_c,infected$month),2),2)

#by season - colds more likely in winter if infected
barplot(round(prop.table(table(Ava_BCS_infected$post.clincold,Ava_BCS_infected$season),2),2))
round(prop.table(table(Ava_BCS_virus$post.clincold,Ava_BCS_virus$season),2),2)

#by season, infection more likely in summer
barplot(round(prop.table(table(Ava_BCS_virus$post.infected, Ava_BCS_virus$season),2),2))
round(prop.table(table(Ava_BCS_virus$post.infected,Ava_BCS_virus$season),2),2)
barplot(round(prop.table(table(Ava_BCS_virus$post.infected, Ava_BCS_virus$month),2),2))

Ava_BCS_virus$post.clincold<-as.factor(Ava_BCS_virus$post.clincold)
Ava_BCS_virus$post.infected<-as.factor(Ava_BCS_virus$post.infected)
###################################################################

#logistic regression - is infection more likely in winter
x<-glm(factor(post.infected)~daylength,family="binomial", data=Ava_BCS)
summary(x)

#only rhinovirus

virus_BCS<-c("rv2","rv9","rv14","cov229e","rsv")
test<-delete
[delete$rv9==1|delete$cov229e==1,]


#Rhinovirus only
rhino<-Ava_BCS[Ava_BCS$rv2==1|Ava_BCS$rv9==1|Ava_BCS$rv14==1,]
rhino_infected<-Ava_BCS[Ava_BCS$post.infected=="Yes",]

gotcold<-as.matrix(table(rhino_infected$season,as.factor(rhino_infected$post.clincold)))
chisq <- chisq.test(gotcold)
chisq

gotinfection<-as.matrix(table(Ava_BCS$season,Ava_BCS$post.infected))
chisq <- chisq.test(gotinfection)
chisq

summary(glm(post.clincold~daylength,family="binomial", data=rhino_infected))
summary(glm(post.infected~daylength,family="binomial", data=rhino_infected))

summary(glm(post.clincold~season,family="binomial", data=rhino_infected))
summary(glm(post.infected~season,family="binomial", data=rhino))

plot(as.factor(rhino$season),rhino$post.infected,ylim=c(.5,1))
plot(as.factor(rhino_infected$season),rhino_infected$post.clincold,ylim=c(0,1))


#################################################################################
# Final data for publication
#################################################################################
BCS$edu
#mixed model with study id and subject as random effect removing flu+ (1|subj_id)
bcs_infect<-glmer(post.infected ~ daylength + age + sex + bodymass + pre_igg + act.recsprts + educ4 + sni.network + smk.cignow + drinks + slp.hrs  + (1|subj_id),nAGQ = 0 ,family="binomial", data=BCS)
bcs_disease<-glmer(post.clincold ~daylength + age + sex + bodymass + pre_igg + act.recsprts + educ4 + sni.network + smk.cignow +  drinks + slp.hrs   + (1|subj_id),nAGQ = 0 ,family="binomial", data=BCS[BCS$post.infected=="1",])

CI_BCS_disease <- glm(post.clincold ~ daylength + pre_igg + +sex + age + drinks + slp.hrs,family="binomial", data=BCS[BCS$post.infected=="1",])
CI_BCS_infect<-glm(post.infected ~ daylength + pre_igg +  smk.cignow ,family="binomial",data=BCS)

summary(glm(post.clincold ~ daylength + pre_ab + +sex + age + drinks + slp.hrs,family="binomial", data=BCS[BCS$post.infected=="1",]))
summary(glm(post.infected ~ daylength + pre_ab +  smk.cignow ,family="binomial",data=BCS))

#get confidence intervals and pvalues
library(broom.mixed)
tidy(CI_BCS_infect,conf.int=TRUE,exponentiate=FALSE,effects="fixed")
tidy(CI_BCS_disease,conf.int=TRUE,exponentiate=FALSE,effects="fixed")

tab_model(bcs_infect)
tab_model(bcs_disease)

##############################################################

#make alcohol binary as more than half didn't drink
hist(BCS$alc.totdrnks)
BCS$drinks<-ifelse(as.numeric(BCS$alc.totdrnks) > 1, "1", "0")
table(as.numeric(BCS$drinks))
BCS$drinks<-factor(BCS$drinks)
table(BCS$drinks)
#adjusting alcohol for log scale


tidy(bcs_disease,conf.int=TRUE,exponentiate=TRUE,effects="fixed")


# CI disease 0.767    0.636      0.924
exp(0.767)
exp(0.636)
exp(0.924)
#CI infection 0.8430.678      1.05 
exp(0.84)
exp(1.05)
exp(0.68)

#recode education into 4 categories
#0=no schooling
#1=primary education only
#2=some secondary ed, left school before 16
#3=secondary ed: completed O-levels
#4=secondary ed: completed A-levels
#5=ge 1 year of University but no degree
#6=University graduate, BA or BSc
#7=Masters degree, MA or MSc
#8=higher degree, PhD, MD, or other

#1 0,1,2,3            up to o level
#2 4                  up to a level 
#3  4.5, 5 5.5        Univeristy but no degree        
#4 6, 7, 8            degree or higher

#FRQ012
#0=never or very infrequently
#1=sometimes
#2=frequently

# 0 = never or only sometimes
# 1 = frequesntly


BCS$post.clincold<-as.factor(BCS$post.clincold)
BCS$act.recsprts<-as.factor(BCS$act.recsprts)

levels(BCS$educ4) <- list("1" = c(1,2,3), "2" = c(4), "3" =c(5,5.5,4.5), "4" = c(6,7,8))
levels(BCS$smk.now)[levels(BCS$smk.now)=='#NULL!'] <- NA


#PMBC and PCS3 included a screening sample collected 2 months prior to viral challenge. excluded f Ab titers were >4 - so thats where the 4 threshold comes from
BCS$pre_igg<-ifelse(BCS$pre_ab > 2, "1", "0")
BCS$pre_igg<-as.factor(BCS$pre_igg)
table((BCS$pre_igg))
table(BCS$pre_ab)

#equivalent categories in pittsburgh
BCS[,c("hsetot","bodymass","slp.hrs","age","act.aerobic")] <- sapply(BCS[,c("hsetot","bodymass","slp.hrs","age","act.aerobic")],as.numeric) 
BCS[,c("sex","smk.cignow","ownedu","educatn","pre_ab",)] <- lapply(BCS[,c("sex","smk.cignow","ownedu","educatn","pre_ab","act.aerobic")],factor) 

BCS[cols] <- lapply(data[cols], factor)

#infections were higher in summer, and colds higher in winter, but only colds related to daylength
#All virus
summary(glm(as.factor(post.clincold)~daylength,family="binomial", data=Ava_BCS_infected))
summary(glm(post.infected~daylength,family="binomial", data=Ava_BCS))

summary(glm(as.factor(post.clincold)~season,family="binomial", data=Ava_BCS_infected))
summary(glm(post.infected~season,family="binomial", data=Ava_BCS))

plot(as.factor(Ava_BCS$season),Ava_BCS$post.infected,ylim=c(.5,1))
plot(as.factor(Ava_BCS_infected$season),as.factor(Ava_BCS_infected$post.clincold),ylim=c(0,1))


#############################################################
#   Table S1
#############################################################

my.render.cont <- function(x) {with(stats.apply.rounding(stats.default(x), digits=4), c("","Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))}
my.render.cat <- function(x) {c("", sapply(stats.default(x), function(y) with(y, sprintf("%d (%0.0f %%)", FREQ, PCT))))}
my.render.NP_cont <- function(x) {with(stats.apply.rounding(stats.default(x), digits=0), c("","Median (IQR)"=sprintf("%s (&plusmn; %s)", MEDIAN, IQR)))}

table1_bcs<-table1(~ daylength + age + sex + bodymass + pre_igg + act.aerobic + educ4 + sni.network   + smk.cignow + drinks + slp.hrs + post.infected +post.clincold ,  data=BCS, overall=TRUE, render.continuous=my.render.cont, render.categorical=my.render.cat)
tables_bydisease <- table1(~ daylength + age + sex + bodymass + pre_igg + act.aerobic + educ4 + sni.network + smk.cignow + drinks + slp.hrs|post.clincold,  data=BCS[BCS$post.infected==1,], overall=TRUE, render.continuous=my.render.cont, render.categorical=my.render.cat)
table_byintfected <- table1(~ daylength + age + sex + bodymass + pre_igg + act.aerobic + educ4 + sni.network   + smk.cignow + drinks + slp.hrs|post.infected,  data=BCS, overall=TRUE, render.continuous=my.render.cont, render.categorical=my.render.cat)


vars<-c('daylength', 'age' , 'sex', 'bodymass' , 'pre_igg' , 'act.recsprts' , 'educ4' , 'sni.network' , 'smk.cignow' , 'alc.totdrnks' , 'slp.hrs')

tableOne_BCS_infect <- CreateTableOne(vars = vars, strata = c("post.infected"), data = BCS)
tableOne_BCS_disease <- CreateTableOne(vars = vars, strata = c("post.clincold"), data=BCS[BCS$post.infected=="1",])


#month plots
table(Ava_BCS$month,Ava_BCS$virus)
table(Ava_BCS$season,Ava_BCS$virus)
tab_xtab (Ava_BCS$month, Ava_BCS$virus)
tab_xtab (Ava_BCS$season, Ava_BCS$virus)


###########################################################
#
#Fig1b
#
#############################################################
   
#change m1 and m2 to all except flu
m3<- bcs_infect
m4<- bcs_disease
summary(bcs_disease)
forest2<-plot_summs(m3,m4, exp=TRUE,
                    model.names=c("Post-Challenge Infection","Post-Infection Clinical Disease"),
                    legend.title="Model Outcome",
                    colors=c("#EFC00099", "#0073C299"),
                    inner_ci_level = .95,
                    coefs = c("Daylength" = "daylength",
                              "Age" = "age",
                              "Sex" = "sex",
                              "BMI" = "bodymass",
                              "Baseline Immunity" = "pre_igg",
                              "Social Networks" = "sni.network",
                              "Sleep" = "slp.hrs",
                              #"Physical Activity"="act.recsprts",
                              #"Smoking" = "smk.cignow",
                              "Alcohol" = "drinks"),
                    scale = TRUE
)
forest2<- forest2 +
  xlab("Odds Ratio and 95% CI")+
  ylab("" )+
  theme_minimal()+
  ggtitle("British Cold Studies") 

#using ggsave
ggsave("Fig1b.png", units="in", width=6, height=5, dpi=300)

########################################################################################

